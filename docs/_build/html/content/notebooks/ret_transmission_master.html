

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Transmission spectrum retrieval: main script &mdash; petitRADTRANS 2.3.1 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
        <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "document", "processClass": "math|output_area"}})</script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/graphviz.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Master retrieval model: transmission case" href="ret_transmission_retrieval_model.html" />
    <link rel="prev" title="OLD (from Mollière+19): Transmission spectrum retrieval" href="../ret_transmission.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> petitRADTRANS
          

          
            
            <img src="../../_static/petitlogo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                2.3
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Guide:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorial.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../available_opacities.html">Available opacity species</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../retrieval_examples.html">Retrieval Examples</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="pRT_Retrieval_Example.html">petitRADTRANS Retrieval Tutorial</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../ret_transmission.html">OLD (from Mollière+19): Transmission spectrum retrieval</a><ul class="current">
<li class="toctree-l3 current"><a class="current reference internal" href="#">Transmission spectrum retrieval: main script</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#General-setup">General setup</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Reading-the-observational-data-in">Reading the observational data in</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Creating-the-radiative-transfer-object">Creating the radiative transfer object</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Prior-setup-for-retrieval">Prior setup for retrieval</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Define-the-log-probability-function">Define the log-probability function</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Run-the-MCMC:-pre-burn">Run the MCMC: pre-burn</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Run-the-main-MCMC-chain">Run the main MCMC chain</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Save-the-results">Save the results</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="ret_transmission_retrieval_model.html">Master retrieval model: transmission case</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../ret_emission.html">OLD (from Mollière+19): Emission spectrum retrieval</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ret_analysis.html">OLD (from Mollière+19): Analysis of results</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../opa_add.html">Adding opacities</a></li>
</ul>
<p class="caption"><span class="caption-text">Code documentation:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../nat_cst_doc.html">nat_cst constants</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../autoapi/index.html">API Reference</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">petitRADTRANS</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../retrieval_examples.html">Retrieval Examples</a> &raquo;</li>
        
          <li><a href="../ret_transmission.html">OLD (from Mollière+19): Transmission spectrum retrieval</a> &raquo;</li>
        
      <li>Transmission spectrum retrieval: main script</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/content/notebooks/ret_transmission_master.ipynb.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container,
div.nbinput.container div.prompt,
div.nbinput.container div.input_area,
div.nbinput.container div[class*=highlight],
div.nbinput.container div[class*=highlight] pre,
div.nboutput.container,
div.nboutput.container div.prompt,
div.nboutput.container div.output_area,
div.nboutput.container div[class*=highlight],
div.nboutput.container div[class*=highlight] pre {
    background: none;
    border: none;
    padding: 0 0;
    margin: 0;
    box-shadow: none;
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    min-width: 5ex;
    padding-top: 0.4em;
    padding-right: 0.4em;
    text-align: right;
    flex: 0;
}
@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    padding: 0.4em;
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    background: #f5f5f5;
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<section id="Transmission-spectrum-retrieval:-main-script">
<h1>Transmission spectrum retrieval: main script<a class="headerlink" href="#Transmission-spectrum-retrieval:-main-script" title="Permalink to this headline">¶</a></h1>
<p>This section shows the main script of the implementation of the transmission spectrum retrieval. The source <code class="docutils literal notranslate"><span class="pre">retrieve_transmission_paper.py</span></code> can be found in the <code class="docutils literal notranslate"><span class="pre">petitRADTRANS</span></code> source folder, in the sub folder <code class="docutils literal notranslate"><span class="pre">retrieval_examples/transmission</span></code>. This is the implementation used for the transmission retrieval case of the <a class="reference external" href="https://arxiv.org/abs/1904.11504">petitRADTRANS paper</a>. In this retrieval we make use of the <a class="reference external" href="https://emcee.readthedocs.io">emcee</a> package, see <a class="reference external" href="https://arxiv.org/abs/1202.3665">Foreman-Mackey et al.
(2012)</a>.</p>
<section id="General-setup">
<h2>General setup<a class="headerlink" href="#General-setup" title="Permalink to this headline">¶</a></h2>
<p>First we load all outside packages:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">emcee</span>
<span class="kn">import</span> <span class="nn">pickle</span> <span class="k">as</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">emcee.utils</span> <span class="kn">import</span> <span class="n">MPIPool</span>
</pre></div>
</div>
</div>
<p>Importing <code class="docutils literal notranslate"><span class="pre">MPIPool</span></code> allows to use <code class="docutils literal notranslate"><span class="pre">mpirun</span></code> on the cluster for parallelization. In practise we always used multiprocessing, however, also on the cluster (see below).</p>
<p>Next we load petitRADTRANS and other packages written for this retrieval setup:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">petitRADTRANS</span> <span class="kn">import</span> <span class="n">Radtrans</span>
<span class="kn">from</span> <span class="nn">petitRADTRANS</span> <span class="kn">import</span> <span class="n">nat_cst</span> <span class="k">as</span> <span class="n">nc</span>
<span class="kn">import</span> <span class="nn">master_retrieval_model</span> <span class="k">as</span> <span class="nn">rm</span>
<span class="kn">import</span> <span class="nn">rebin_give_width</span> <span class="k">as</span> <span class="nn">rgw</span>
</pre></div>
</div>
</div>
<p>The package <code class="docutils literal notranslate"><span class="pre">master_retrieval_model.py</span></code> contains the function that returns the model spectrum, given the input parameters. It can be found in <code class="docutils literal notranslate"><span class="pre">retrieval_examples/transmission</span></code> as well, and is explained <a class="reference external" href="ret_transmission_retrieval_model.html">here</a>.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">rebin_give_width.so</span></code> package is a Fortran binary compiled for use in Python, written specifically for this retrieval example. It is written in Fortran to increase speed. It rebins the forward model to the observational wavelength grid, with the width of the wavelength bin given for every grid point. It is compiled by typing:</p>
<p><code class="docutils literal notranslate"><span class="pre">f2py</span> <span class="pre">-c</span> <span class="pre">--opt='-O3</span> <span class="pre">-funroll-loops</span> <span class="pre">-ftree-vectorize</span> <span class="pre">-ftree-loop-optimize</span> <span class="pre">-msse</span> <span class="pre">-msse2</span> <span class="pre">-m3dnow'</span> <span class="pre">-m</span> <span class="pre">rebin_give_width</span> <span class="pre">rebin_give_width.f90</span></code></p>
<p>If it won’t run, also see the general installation tips of petitRADTRANS, when building <code class="docutils literal notranslate"><span class="pre">.so</span></code> files, <a class="reference external" href="../installation.html">here</a>.</p>
<p>Next we specify the observation paths:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">retrieval_name</span> <span class="o">=</span> <span class="s1">&#39;JWST_transmission_petitRADTRANSpaper&#39;</span>
<span class="n">absolute_path</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="c1"># end with forward slash!</span>
<span class="n">observation_files</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">observation_files</span><span class="p">[</span><span class="s1">&#39;NIRISS SOSS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;NIRISS_SOSS.dat&#39;</span>
<span class="n">observation_files</span><span class="p">[</span><span class="s1">&#39;NIRSpec G395M&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;NIRSpec_G395M.dat&#39;</span>
<span class="n">observation_files</span><span class="p">[</span><span class="s1">&#39;MIRI LRS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;MIRI_LRS.dat&#39;</span>
</pre></div>
</div>
</div>
<p>If you want to plot the spectra for testing purposes (i.e. when running locally on your machine, on a single core), set <code class="docutils literal notranslate"><span class="pre">plotting</span> <span class="pre">=</span> <span class="pre">True</span></code>. Don’t do this when you run the actual retrieval:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># For testing purposes only</span>
<span class="n">plotting</span> <span class="o">=</span> <span class="kc">False</span>
<span class="k">if</span> <span class="n">plotting</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">pylab</span> <span class="k">as</span> <span class="nn">plt</span>
</pre></div>
</div>
</div>
<p>Next we setup the hyperparameters of the emcee MCMC sampler:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Retrieval hyperparameters</span>
<span class="n">stepsize</span> <span class="o">=</span> <span class="mf">1.75</span>
<span class="n">n_walkers</span> <span class="o">=</span> <span class="mi">240</span>
<span class="n">n_iter</span> <span class="o">=</span> <span class="mi">4200</span>
</pre></div>
</div>
</div>
<p>The 240 walkers will carry out 4200 steps, that is we will draw 1,008,000 samples.</p>
<p>Put <code class="docutils literal notranslate"><span class="pre">cluster</span></code> to <code class="docutils literal notranslate"><span class="pre">True</span></code> if you want to run with <code class="docutils literal notranslate"><span class="pre">mpirun</span></code> on the cluster. We only used multiprocessing in our cases, that is leaving <code class="docutils literal notranslate"><span class="pre">cluster</span> <span class="pre">=</span> <span class="pre">False</span></code> and setting <code class="docutils literal notranslate"><span class="pre">n_threads</span> <span class="pre">=</span> <span class="pre">40</span></code> when running on, for example, 40 cores.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">cluster</span> <span class="o">=</span> <span class="kc">False</span>       <span class="c1"># Submit to cluster</span>
<span class="n">n_threads</span> <span class="o">=</span> <span class="mi">1</span>         <span class="c1"># Use mutliprocessing (local = 1)</span>
<span class="n">write_threshold</span> <span class="o">=</span> <span class="mi">200</span> <span class="c1"># number of iterations after which diagnostics are updated</span>
</pre></div>
</div>
</div>
<p>Next we specify the wavelength range of the models (a bit larger than that of the observations), and fixed parameters that will not be retrieved for the transmission spectrum case. Don’t make the wavelength range larger than needed, it will decrease the forward modeling speed.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">WLEN</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">14.0</span><span class="p">]</span>
<span class="n">LOG_G</span> <span class="o">=</span>  <span class="mf">2.58</span>
<span class="n">R_pl</span> <span class="o">=</span>   <span class="mf">1.84</span><span class="o">*</span><span class="n">nc</span><span class="o">.</span><span class="n">r_jup_mean</span>
<span class="n">R_star</span> <span class="o">=</span> <span class="mf">1.81</span><span class="o">*</span><span class="n">nc</span><span class="o">.</span><span class="n">r_sun</span>
</pre></div>
</div>
</div>
</section>
<section id="Reading-the-observational-data-in">
<h2>Reading the observational data in<a class="headerlink" href="#Reading-the-observational-data-in" title="Permalink to this headline">¶</a></h2>
<p>See the headers of the data files for the units. We read in the wavelength, the relative flux decrease <span class="math notranslate nohighlight">\((R_{\rm planet}/R_*)^2\)</span>, and its error.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Read in data, convert all to cgs!</span>
<span class="n">data_wlen</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">data_flux_lambda</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">data_flux_lambda_error</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">data_wlen_bins</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">observation_files</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>

    <span class="n">dat_obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="n">observation_files</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>
    <span class="n">data_wlen</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">dat_obs</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mf">1e-4</span>
    <span class="n">data_flux_lambda</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">dat_obs</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">data_flux_lambda_error</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">dat_obs</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span>

    <span class="n">data_wlen_bins</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">data_wlen</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>
    <span class="n">data_wlen_bins</span><span class="p">[</span><span class="n">name</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">data_wlen</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>
    <span class="n">data_wlen_bins</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_wlen_bins</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
</pre></div>
</div>
</div>
</section>
<section id="Creating-the-radiative-transfer-object">
<h2>Creating the radiative transfer object<a class="headerlink" href="#Creating-the-radiative-transfer-object" title="Permalink to this headline">¶</a></h2>
<p>This object will later be used by the <code class="docutils literal notranslate"><span class="pre">master_retrieval_model.py</span></code> package.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1">### Create and setup radiative transfer object</span>
<span class="c1"># Create random P-T profile to create RT arrays of the Radtrans object.</span>
<span class="n">temp_params</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">temp_params</span><span class="p">[</span><span class="s1">&#39;log_delta&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">6.</span>
<span class="n">temp_params</span><span class="p">[</span><span class="s1">&#39;log_gamma&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="mf">0.4</span><span class="p">)</span>
<span class="n">temp_params</span><span class="p">[</span><span class="s1">&#39;t_int&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">750.</span>
<span class="n">temp_params</span><span class="p">[</span><span class="s1">&#39;t_equ&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
<span class="n">temp_params</span><span class="p">[</span><span class="s1">&#39;log_p_trans&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">3.</span>
<span class="n">temp_params</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
<span class="n">p</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">nc</span><span class="o">.</span><span class="n">make_press_temp</span><span class="p">(</span><span class="n">temp_params</span><span class="p">)</span>

<span class="c1"># Create the Ratrans object here</span>
<span class="n">rt_object</span> <span class="o">=</span> <span class="n">Radtrans</span><span class="p">(</span><span class="n">line_species</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;H2&#39;</span><span class="p">,</span> <span class="s1">&#39;CO_all_iso&#39;</span><span class="p">,</span> <span class="s1">&#39;H2O&#39;</span><span class="p">,</span> \
                                  <span class="s1">&#39;CH4&#39;</span><span class="p">,</span> <span class="s1">&#39;NH3&#39;</span><span class="p">,</span> <span class="s1">&#39;CO2&#39;</span><span class="p">,</span> <span class="s1">&#39;H2S&#39;</span><span class="p">,</span> \
                                  <span class="s1">&#39;Na&#39;</span><span class="p">,</span> <span class="s1">&#39;K&#39;</span><span class="p">],</span> \
                    <span class="n">rayleigh_species</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;H2&#39;</span><span class="p">,</span><span class="s1">&#39;He&#39;</span><span class="p">],</span> \
                    <span class="n">continuum_opacities</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;H2-H2&#39;</span><span class="p">,</span><span class="s1">&#39;H2-He&#39;</span><span class="p">],</span> \
                    <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;c-k&#39;</span><span class="p">,</span> \
                    <span class="n">wlen_bords_micron</span> <span class="o">=</span> <span class="n">WLEN</span><span class="p">)</span>

<span class="c1"># Create the RT arrays of appropriate lengths</span>
<span class="n">rt_object</span><span class="o">.</span><span class="n">setup_opa_structure</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
  Read CIA opacities for H2-H2...
  Read CIA opacities for H2-He...
 Done.

</pre></div></div>
</div>
</section>
<section id="Prior-setup-for-retrieval">
<h2>Prior setup for retrieval<a class="headerlink" href="#Prior-setup-for-retrieval" title="Permalink to this headline">¶</a></h2>
<p>Here we set up the priors for the temperature profile parameters, abundances, and other free parameters, as described in the petitRADTRANS paper.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">b_range</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="n">b</span><span class="p">:</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">0.</span>

<span class="k">def</span> <span class="nf">a_b_range</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">a</span><span class="p">:</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
    <span class="k">elif</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="n">b</span><span class="p">:</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">0.</span>

<span class="n">log_priors</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">log_priors</span><span class="p">[</span><span class="s1">&#39;log_delta&#39;</span><span class="p">]</span>      <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="o">-</span><span class="p">((</span><span class="n">x</span><span class="o">-</span><span class="p">(</span><span class="o">-</span><span class="mf">5.5</span><span class="p">))</span><span class="o">/</span><span class="mf">2.5</span><span class="p">)</span><span class="o">**</span><span class="mf">2.</span><span class="o">/</span><span class="mf">2.</span>
<span class="n">log_priors</span><span class="p">[</span><span class="s1">&#39;log_gamma&#39;</span><span class="p">]</span>      <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="o">-</span><span class="p">((</span><span class="n">x</span><span class="o">-</span><span class="p">(</span><span class="o">-</span><span class="mf">0.0</span><span class="p">))</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span><span class="o">**</span><span class="mf">2.</span><span class="o">/</span><span class="mf">2.</span>
<span class="n">log_priors</span><span class="p">[</span><span class="s1">&#39;t_int&#39;</span><span class="p">]</span>          <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">a_b_range</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">1500.</span><span class="p">)</span>
<span class="n">log_priors</span><span class="p">[</span><span class="s1">&#39;t_equ&#39;</span><span class="p">]</span>          <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">a_b_range</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">4000.</span><span class="p">)</span>
<span class="n">log_priors</span><span class="p">[</span><span class="s1">&#39;log_p_trans&#39;</span><span class="p">]</span>    <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="o">-</span><span class="p">((</span><span class="n">x</span><span class="o">-</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">))</span><span class="o">/</span><span class="mf">3.</span><span class="p">)</span><span class="o">**</span><span class="mf">2.</span><span class="o">/</span><span class="mf">2.</span>
<span class="n">log_priors</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span>          <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="o">-</span><span class="p">((</span><span class="n">x</span><span class="o">-</span><span class="mf">0.25</span><span class="p">)</span><span class="o">/</span><span class="mf">0.4</span><span class="p">)</span><span class="o">**</span><span class="mf">2.</span><span class="o">/</span><span class="mf">2.</span>
<span class="n">log_priors</span><span class="p">[</span><span class="s1">&#39;log_g&#39;</span><span class="p">]</span>          <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">a_b_range</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">,</span> <span class="mf">3.7</span><span class="p">)</span>
<span class="n">log_priors</span><span class="p">[</span><span class="s1">&#39;log_P0&#39;</span><span class="p">]</span>         <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">a_b_range</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="mf">2.</span><span class="p">)</span>

<span class="c1"># Priors for log mass fractions</span>
<span class="n">log_priors</span><span class="p">[</span><span class="s1">&#39;CO_all_iso&#39;</span><span class="p">]</span>     <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">a_b_range</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">-</span><span class="mf">10.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
<span class="n">log_priors</span><span class="p">[</span><span class="s1">&#39;H2O&#39;</span><span class="p">]</span>            <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">a_b_range</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">-</span><span class="mf">10.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
<span class="n">log_priors</span><span class="p">[</span><span class="s1">&#39;CH4&#39;</span><span class="p">]</span>            <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">a_b_range</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">-</span><span class="mf">10.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
<span class="n">log_priors</span><span class="p">[</span><span class="s1">&#39;NH3&#39;</span><span class="p">]</span>            <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">a_b_range</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">-</span><span class="mf">10.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
<span class="n">log_priors</span><span class="p">[</span><span class="s1">&#39;CO2&#39;</span><span class="p">]</span>            <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">a_b_range</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">-</span><span class="mf">10.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
<span class="n">log_priors</span><span class="p">[</span><span class="s1">&#39;H2S&#39;</span><span class="p">]</span>            <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">a_b_range</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">-</span><span class="mf">10.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
<span class="n">log_priors</span><span class="p">[</span><span class="s1">&#39;Na&#39;</span><span class="p">]</span>             <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">a_b_range</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">-</span><span class="mf">10.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
<span class="n">log_priors</span><span class="p">[</span><span class="s1">&#39;K&#39;</span><span class="p">]</span>              <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">a_b_range</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">-</span><span class="mf">10.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="Define-the-log-probability-function">
<h2>Define the log-probability function<a class="headerlink" href="#Define-the-log-probability-function" title="Permalink to this headline">¶</a></h2>
<p>First we set up the variables that will be changed and be written into the diagnostice file, during the retrieval run:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Declare diagnostics</span>
<span class="n">function_calls</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">computed_spectra</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">NaN_spectra</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">delta_wt</span> <span class="o">=</span> <span class="n">write_threshold</span>

<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">file_object</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">absolute_path</span> <span class="o">+</span> <span class="s1">&#39;diag_&#39;</span> <span class="o">+</span> \
                       <span class="n">retrieval_name</span> <span class="o">+</span> <span class="s1">&#39;.dat&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</div>
<p>Here it comes…. the log-probability function! I tried to comment it sufficiently, shoot me an email if something is unclear.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">calc_log_prob</span><span class="p">(</span><span class="n">params</span><span class="p">):</span>

    <span class="n">log_delta</span><span class="p">,</span> <span class="n">log_gamma</span><span class="p">,</span> <span class="n">t_int</span><span class="p">,</span> <span class="n">t_equ</span><span class="p">,</span> <span class="n">log_p_trans</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> \
      <span class="n">log_g</span><span class="p">,</span> <span class="n">log_P0</span> <span class="o">=</span> <span class="n">params</span><span class="p">[:</span><span class="o">-</span><span class="mi">8</span><span class="p">]</span>

    <span class="c1"># Make dictionary for modified Guillot parameters</span>
    <span class="n">temp_params</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">temp_params</span><span class="p">[</span><span class="s1">&#39;log_delta&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">log_delta</span>
    <span class="n">temp_params</span><span class="p">[</span><span class="s1">&#39;log_gamma&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">log_gamma</span>
    <span class="n">temp_params</span><span class="p">[</span><span class="s1">&#39;t_int&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">t_int</span>
    <span class="n">temp_params</span><span class="p">[</span><span class="s1">&#39;t_equ&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">t_equ</span>
    <span class="n">temp_params</span><span class="p">[</span><span class="s1">&#39;log_p_trans&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">log_p_trans</span>
    <span class="n">temp_params</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">alpha</span>

    <span class="c1"># Make dictionary for log &#39;metal&#39; abundances</span>
    <span class="n">ab_metals</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">ab_metals</span><span class="p">[</span><span class="s1">&#39;CO_all_iso&#39;</span><span class="p">]</span>     <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="o">-</span><span class="mi">8</span><span class="p">:][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">ab_metals</span><span class="p">[</span><span class="s1">&#39;H2O&#39;</span><span class="p">]</span>            <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="o">-</span><span class="mi">8</span><span class="p">:][</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">ab_metals</span><span class="p">[</span><span class="s1">&#39;CH4&#39;</span><span class="p">]</span>            <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="o">-</span><span class="mi">8</span><span class="p">:][</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">ab_metals</span><span class="p">[</span><span class="s1">&#39;NH3&#39;</span><span class="p">]</span>            <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="o">-</span><span class="mi">8</span><span class="p">:][</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">ab_metals</span><span class="p">[</span><span class="s1">&#39;CO2&#39;</span><span class="p">]</span>            <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="o">-</span><span class="mi">8</span><span class="p">:][</span><span class="mi">4</span><span class="p">]</span>
    <span class="n">ab_metals</span><span class="p">[</span><span class="s1">&#39;H2S&#39;</span><span class="p">]</span>            <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="o">-</span><span class="mi">8</span><span class="p">:][</span><span class="mi">5</span><span class="p">]</span>
    <span class="n">ab_metals</span><span class="p">[</span><span class="s1">&#39;Na&#39;</span><span class="p">]</span>             <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="o">-</span><span class="mi">8</span><span class="p">:][</span><span class="mi">6</span><span class="p">]</span>
    <span class="n">ab_metals</span><span class="p">[</span><span class="s1">&#39;K&#39;</span><span class="p">]</span>              <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="o">-</span><span class="mi">8</span><span class="p">:][</span><span class="mi">7</span><span class="p">]</span>

    <span class="k">global</span> <span class="n">function_calls</span>
    <span class="k">global</span> <span class="n">computed_spectra</span>
    <span class="k">global</span> <span class="n">NaN_spectra</span>
    <span class="k">global</span> <span class="n">write_threshold</span>

    <span class="n">function_calls</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="c1"># Prior calculation of all input parameters</span>
    <span class="n">log_prior</span> <span class="o">=</span> <span class="mf">0.</span>

    <span class="c1"># Alpha should not be smaller than -1, this</span>
    <span class="c1"># would lead to negative temperatures!</span>
    <span class="k">if</span> <span class="n">alpha</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>

    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">temp_params</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">log_prior</span> <span class="o">+=</span> <span class="n">log_priors</span><span class="p">[</span><span class="n">key</span><span class="p">](</span><span class="n">temp_params</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>

    <span class="n">log_prior</span> <span class="o">+=</span> <span class="n">log_priors</span><span class="p">[</span><span class="s1">&#39;log_g&#39;</span><span class="p">](</span><span class="n">log_g</span><span class="p">)</span>
    <span class="n">log_prior</span> <span class="o">+=</span> <span class="n">log_priors</span><span class="p">[</span><span class="s1">&#39;log_P0&#39;</span><span class="p">](</span><span class="n">log_P0</span><span class="p">)</span>

    <span class="c1"># Metal abundances: check that their</span>
    <span class="c1"># summed mass fraction is below 1.</span>
    <span class="n">metal_sum</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">ab_metals</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">log_prior</span> <span class="o">+=</span> <span class="n">log_priors</span><span class="p">[</span><span class="n">name</span><span class="p">](</span><span class="n">ab_metals</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>
        <span class="n">metal_sum</span> <span class="o">+=</span> <span class="mf">1e1</span><span class="o">**</span><span class="n">ab_metals</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">metal_sum</span> <span class="o">&gt;</span> <span class="mf">1.</span><span class="p">:</span>
        <span class="n">log_prior</span> <span class="o">+=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>

    <span class="c1"># Return -inf if parameters fall outside prior distribution</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">log_prior</span> <span class="o">==</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">):</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>

    <span class="c1"># Calculate the log-likelihood</span>
    <span class="n">log_likelihood</span> <span class="o">=</span> <span class="mf">0.</span>

    <span class="c1"># Calculate the forward model, this</span>
    <span class="c1"># returns the wavelengths in cm and the planet radius</span>
    <span class="c1"># in R_jup.</span>
    <span class="n">wlen</span><span class="p">,</span> <span class="n">flux_lambda</span> <span class="o">=</span> \
            <span class="n">rm</span><span class="o">.</span><span class="n">retrieval_model_plain</span><span class="p">(</span><span class="n">rt_object</span><span class="p">,</span> <span class="n">temp_params</span><span class="p">,</span> <span class="n">log_g</span><span class="p">,</span> \
                                         <span class="n">log_P0</span><span class="p">,</span> <span class="n">R_pl</span><span class="p">,</span> <span class="n">ab_metals</span><span class="p">)</span>

    <span class="c1"># Just to make sure that a long chain does not die</span>
    <span class="c1"># unexpectedly:</span>
    <span class="c1"># Return -inf if retrieval model returns NaN values</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">flux_lambda</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;NaN spectrum encountered&quot;</span><span class="p">)</span>
        <span class="n">NaN_spectra</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>

    <span class="c1"># Convert to observation for transmission case</span>
    <span class="n">flux_sq</span> <span class="o">=</span> <span class="p">(</span><span class="n">flux_lambda</span><span class="o">*</span><span class="n">nc</span><span class="o">.</span><span class="n">r_jup_mean</span><span class="o">/</span><span class="n">R_star</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>

    <span class="c1"># Calculate log-likelihood</span>
    <span class="k">for</span> <span class="n">instrument</span> <span class="ow">in</span> <span class="n">data_wlen</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>

        <span class="c1"># Rebin model to observation</span>
        <span class="n">flux_rebinned</span> <span class="o">=</span> <span class="n">rgw</span><span class="o">.</span><span class="n">rebin_give_width</span><span class="p">(</span><span class="n">wlen</span><span class="p">,</span> <span class="n">flux_sq</span><span class="p">,</span> \
                        <span class="n">data_wlen</span><span class="p">[</span><span class="n">instrument</span><span class="p">],</span> <span class="n">data_wlen_bins</span><span class="p">[</span><span class="n">instrument</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">plotting</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">data_wlen</span><span class="p">[</span><span class="n">instrument</span><span class="p">],</span> \
                             <span class="n">data_flux_lambda</span><span class="p">[</span><span class="n">instrument</span><span class="p">],</span> \
                             <span class="n">data_flux_lambda_error</span><span class="p">[</span><span class="n">instrument</span><span class="p">],</span> \
                             <span class="n">fmt</span> <span class="o">=</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> \
                             <span class="n">zorder</span> <span class="o">=</span> <span class="o">-</span><span class="mi">20</span><span class="p">,</span> \
                             <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;red&#39;</span><span class="p">)</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">data_wlen</span><span class="p">[</span><span class="n">instrument</span><span class="p">],</span> \
                             <span class="n">flux_rebinned</span><span class="p">,</span> \
                             <span class="s1">&#39;s&#39;</span><span class="p">,</span> \
                             <span class="n">zorder</span> <span class="o">=</span> <span class="o">-</span><span class="mi">20</span><span class="p">,</span> \
                             <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;blue&#39;</span><span class="p">)</span>

        <span class="c1"># Calculate log-likelihood</span>
        <span class="n">log_likelihood</span> <span class="o">+=</span> \
               <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(((</span><span class="n">flux_rebinned</span> <span class="o">-</span> <span class="n">data_flux_lambda</span><span class="p">[</span><span class="n">instrument</span><span class="p">])</span><span class="o">/</span> \
                    <span class="n">data_flux_lambda_error</span><span class="p">[</span><span class="n">instrument</span><span class="p">])</span><span class="o">**</span><span class="mf">2.</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span>

    <span class="k">if</span> <span class="n">plotting</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wlen</span><span class="p">,</span> <span class="n">flux_sq</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;black&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="n">computed_spectra</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="c1"># Write diagnostics file</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">function_calls</span> <span class="o">&gt;=</span> <span class="n">write_threshold</span><span class="p">):</span>

        <span class="n">write_threshold</span> <span class="o">+=</span> <span class="n">delta_wt</span>
        <span class="n">hours</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span><span class="o">/</span><span class="mf">3600.0</span>
        <span class="n">info_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">function_calls</span><span class="p">,</span> <span class="n">computed_spectra</span><span class="p">,</span> <span class="n">NaN_spectra</span><span class="p">,</span> \
                 <span class="n">log_prior</span> <span class="o">+</span> <span class="n">log_likelihood</span><span class="p">,</span> <span class="n">hours</span><span class="p">]</span>

        <span class="n">file_object</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">absolute_path</span> <span class="o">+</span> <span class="s1">&#39;diag_&#39;</span> <span class="o">+</span> \
                               <span class="n">retrieval_name</span> <span class="o">+</span> <span class="s1">&#39;.dat&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">info_list</span><span class="p">)):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">info_list</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">file_object</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">info_list</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">file_object</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">info_list</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span><span class="p">)</span>
        <span class="n">file_object</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">log_prior</span> <span class="o">+</span> <span class="n">log_likelihood</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--&gt; &quot;</span><span class="p">,</span> <span class="n">function_calls</span><span class="p">,</span> <span class="s2">&quot; --&gt; &quot;</span><span class="p">,</span> <span class="n">computed_spectra</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">log_prior</span> <span class="o">+</span> <span class="n">log_likelihood</span>

<span class="k">def</span> <span class="nf">lnprob</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">calc_log_prob</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="Run-the-MCMC:-pre-burn">
<h2>Run the MCMC: pre-burn<a class="headerlink" href="#Run-the-MCMC:-pre-burn" title="Permalink to this headline">¶</a></h2>
<p>Here we first run a so-called pre-burn, to find the parameter region to zero-in on.</p>
<p>Emcee needs to know the number of parameters:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">n_dim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">log_priors</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Next we set up the initial walker positions:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Set initial position vectors in parameter space</span>
<span class="n">p0</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">loc</span> <span class="o">=</span> <span class="o">-</span><span class="mf">5.5</span><span class="p">,</span> <span class="n">scale</span> <span class="o">=</span> <span class="mf">2.5</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> \
                <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">loc</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span> <span class="o">=</span> <span class="mf">2.</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> \
                <span class="mf">0.</span><span class="o">+</span><span class="mf">1500.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> \
                <span class="mf">0.</span><span class="o">+</span><span class="mf">4000.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> \
                <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">loc</span> <span class="o">=</span> <span class="o">-</span><span class="mf">3.</span><span class="p">,</span> <span class="n">scale</span> <span class="o">=</span> <span class="mf">3.</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> \
                <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">loc</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">scale</span> <span class="o">=</span> <span class="mf">0.4</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> \
                <span class="n">LOG_G</span><span class="p">,</span>
                <span class="o">-</span><span class="mf">4.</span><span class="o">+</span><span class="mf">6.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> \
                <span class="o">-</span><span class="mf">10.</span><span class="o">+</span><span class="mf">10.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> \
                <span class="o">-</span><span class="mf">10.</span><span class="o">+</span><span class="mf">10.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> \
                <span class="o">-</span><span class="mf">10.</span><span class="o">+</span><span class="mf">10.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> \
                <span class="o">-</span><span class="mf">10.</span><span class="o">+</span><span class="mf">10.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> \
                <span class="o">-</span><span class="mf">10.</span><span class="o">+</span><span class="mf">10.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> \
                <span class="o">-</span><span class="mf">10.</span><span class="o">+</span><span class="mf">10.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> \
                <span class="o">-</span><span class="mf">10.</span><span class="o">+</span><span class="mf">10.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> \
                <span class="o">-</span><span class="mf">10.</span><span class="o">+</span><span class="mf">10.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span> \
                <span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_walkers</span><span class="p">)]</span>
</pre></div>
</div>
</div>
<p>Now we run the pre-burn MCMC chain, depending on where and how we want to run it (on the cluster using mpirun, on the cluster (or locally) using multiple cores, or just on a single core):</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">if</span> <span class="n">cluster</span><span class="p">:</span>
    <span class="n">pool</span> <span class="o">=</span> <span class="n">MPIPool</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">pool</span><span class="o">.</span><span class="n">is_master</span><span class="p">():</span>
        <span class="n">pool</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">sampler</span> <span class="o">=</span> <span class="n">emcee</span><span class="o">.</span><span class="n">EnsembleSampler</span><span class="p">(</span><span class="n">n_walkers</span><span class="p">,</span> <span class="n">n_dim</span><span class="p">,</span> <span class="n">lnprob</span><span class="p">,</span> \
                                        <span class="n">a</span> <span class="o">=</span> <span class="n">stepsize</span><span class="p">,</span> <span class="n">pool</span> <span class="o">=</span> <span class="n">pool</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">n_threads</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">sampler</span> <span class="o">=</span> <span class="n">emcee</span><span class="o">.</span><span class="n">EnsembleSampler</span><span class="p">(</span><span class="n">n_walkers</span><span class="p">,</span> <span class="n">n_dim</span><span class="p">,</span> <span class="n">lnprob</span><span class="p">,</span> \
                                            <span class="n">a</span> <span class="o">=</span> <span class="n">stepsize</span><span class="p">,</span> <span class="n">threads</span> <span class="o">=</span> <span class="n">n_threads</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sampler</span> <span class="o">=</span> <span class="n">emcee</span><span class="o">.</span><span class="n">EnsembleSampler</span><span class="p">(</span><span class="n">n_walkers</span><span class="p">,</span> <span class="n">n_dim</span><span class="p">,</span> <span class="n">lnprob</span><span class="p">,</span> \
                                            <span class="n">a</span> <span class="o">=</span> <span class="n">stepsize</span><span class="p">)</span>

<span class="n">pre_burn_in_runs</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="mi">399</span><span class="p">,</span> <span class="n">n_iter</span><span class="o">/</span><span class="mi">10</span><span class="p">]))</span> <span class="o">+</span> <span class="mi">3</span>
<span class="n">pos</span><span class="p">,</span> <span class="n">prob</span><span class="p">,</span> <span class="n">state</span> <span class="o">=</span> <span class="n">sampler</span><span class="o">.</span><span class="n">run_mcmc</span><span class="p">(</span><span class="n">p0</span><span class="p">,</span> <span class="n">pre_burn_in_runs</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>As we have 240 walkers, the value of <code class="docutils literal notranslate"><span class="pre">pre_burn_in_runs</span></code> ensure that we draw at least ~100,000 samples during the pre-burn.</p>
</section>
<section id="Run-the-main-MCMC-chain">
<h2>Run the main MCMC chain<a class="headerlink" href="#Run-the-main-MCMC-chain" title="Permalink to this headline">¶</a></h2>
<p>Now we get the best-fit position of the pre-burn, and restart the actual retrieval in a so-called “Gauss ball” around the best-fit position:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Get the best-fit position</span>
<span class="n">highest_prob_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">sampler</span><span class="o">.</span><span class="n">lnprobability</span><span class="o">.</span><span class="n">argmax</span><span class="p">(),</span> \
                                          <span class="n">sampler</span><span class="o">.</span><span class="n">lnprobability</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">best_position</span> <span class="o">=</span> <span class="n">sampler</span><span class="o">.</span><span class="n">chain</span><span class="p">[</span><span class="n">highest_prob_index</span><span class="p">]</span>

<span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;best_position_pre_burn_in_&#39;</span> <span class="o">+</span> <span class="n">retrieval_name</span> <span class="o">+</span> <span class="s1">&#39;.dat&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
<span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">best_position</span><span class="p">))</span>
<span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="c1"># Run actual chain</span>
<span class="n">p0</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">best_position</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mf">0.8</span><span class="p">,</span> \
                <span class="n">best_position</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mf">0.5</span><span class="p">,</span> \
                <span class="n">best_position</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mf">70.</span><span class="p">,</span> \
                <span class="n">best_position</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mf">200.</span><span class="p">,</span> \
                <span class="n">best_position</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mf">0.5</span><span class="p">,</span> \
                <span class="n">best_position</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mf">0.1</span><span class="p">,</span> \
                <span class="n">LOG_G</span><span class="p">,</span> \
                <span class="n">best_position</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mf">0.2</span><span class="p">,</span> \
                <span class="n">best_position</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mf">0.3</span><span class="p">,</span> \
                <span class="n">best_position</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mf">0.3</span><span class="p">,</span> \
                <span class="n">best_position</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mf">0.3</span><span class="p">,</span> \
                <span class="n">best_position</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mf">0.3</span><span class="p">,</span> \
                <span class="n">best_position</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mf">0.3</span><span class="p">,</span> \
                <span class="n">best_position</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mf">0.3</span><span class="p">,</span> \
                <span class="n">best_position</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mf">0.3</span><span class="p">,</span> \
                <span class="n">best_position</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mf">0.3</span><span class="p">]</span> \
                   <span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_walkers</span><span class="p">)]</span>
</pre></div>
</div>
</div>
<p>And now we run the main chain:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[26]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">if</span> <span class="n">cluster</span><span class="p">:</span>
    <span class="n">sampler</span> <span class="o">=</span> <span class="n">emcee</span><span class="o">.</span><span class="n">EnsembleSampler</span><span class="p">(</span><span class="n">n_walkers</span><span class="p">,</span> <span class="n">n_dim</span><span class="p">,</span> <span class="n">lnprob</span><span class="p">,</span> \
                                        <span class="n">a</span> <span class="o">=</span> <span class="n">stepsize</span><span class="p">,</span> <span class="n">pool</span> <span class="o">=</span> <span class="n">pool</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">n_threads</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">sampler</span> <span class="o">=</span> <span class="n">emcee</span><span class="o">.</span><span class="n">EnsembleSampler</span><span class="p">(</span><span class="n">n_walkers</span><span class="p">,</span> <span class="n">n_dim</span><span class="p">,</span> <span class="n">lnprob</span><span class="p">,</span> \
                                            <span class="n">a</span> <span class="o">=</span> <span class="n">stepsize</span><span class="p">,</span> <span class="n">threads</span> <span class="o">=</span> <span class="n">n_threads</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sampler</span> <span class="o">=</span> <span class="n">emcee</span><span class="o">.</span><span class="n">EnsembleSampler</span><span class="p">(</span><span class="n">n_walkers</span><span class="p">,</span> <span class="n">n_dim</span><span class="p">,</span> <span class="n">lnprob</span><span class="p">,</span> \
                                            <span class="n">a</span> <span class="o">=</span> <span class="n">stepsize</span><span class="p">)</span>

<span class="n">pos</span><span class="p">,</span> <span class="n">prob</span><span class="p">,</span> <span class="n">state</span> <span class="o">=</span> <span class="n">sampler</span><span class="o">.</span><span class="n">run_mcmc</span><span class="p">(</span><span class="n">p0</span><span class="p">,</span> <span class="n">n_iter</span><span class="p">)</span>

<span class="k">if</span> <span class="n">cluster</span><span class="p">:</span>
    <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</div>
</section>
<section id="Save-the-results">
<h2>Save the results<a class="headerlink" href="#Save-the-results" title="Permalink to this headline">¶</a></h2>
<p>Finally, we save the sampled parameter positions <code class="docutils literal notranslate"><span class="pre">samples</span></code> and their associated log-probabilities to two pickle files.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;chain_pos_&#39;</span> <span class="o">+</span> <span class="n">retrieval_name</span> <span class="o">+</span> <span class="s1">&#39;.pickle&#39;</span><span class="p">,</span><span class="s1">&#39;wb&#39;</span><span class="p">)</span>
<span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span><span class="n">f</span><span class="p">)</span>
<span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">prob</span><span class="p">,</span><span class="n">f</span><span class="p">)</span>
<span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">state</span><span class="p">,</span><span class="n">f</span><span class="p">)</span>
<span class="n">samples</span> <span class="o">=</span> <span class="n">sampler</span><span class="o">.</span><span class="n">chain</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_dim</span><span class="p">))</span>
<span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span><span class="n">f</span><span class="p">)</span>
<span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;chain_lnprob_&#39;</span> <span class="o">+</span> <span class="n">retrieval_name</span> <span class="o">+</span> <span class="s1">&#39;.pickle&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">([</span><span class="n">sampler</span><span class="o">.</span><span class="n">lnprobability</span><span class="p">],</span> \
                <span class="n">f</span><span class="p">,</span> <span class="n">protocol</span><span class="o">=</span><span class="n">pickle</span><span class="o">.</span><span class="n">HIGHEST_PROTOCOL</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
</section>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="ret_transmission_retrieval_model.html" class="btn btn-neutral float-right" title="Master retrieval model: transmission case" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="../ret_transmission.html" class="btn btn-neutral float-left" title="OLD (from Mollière+19): Transmission spectrum retrieval" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019-2020, Paul Mollière

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>